; File: platformio.ini
; Configurazione ambienti per il sistema EasyConnect2026

[platformio]
src_dir = src

[env]
; --- IMPOSTAZIONI COMUNI A TUTTE LE SCHEDE ---
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
lib_ldf_mode = deep+
; Forza DIO a livello board (evita boot failure su diversi ESP32-C3 in QIO)
board_build.flash_mode = dio
build_flags = 
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    ; FIX CRITICO: Forza la modalità DIO. Molti C3 non partono in QIO.
    -D BOARD_FLASH_MODE_DIO

; --- 1. SCHEDA MASTER (Standalone / Rewamping) ---
[env:master_rewamping]
; Schema partizioni per OTA (riserva spazio per due copie del firmware)
board_build.partitions = partitions_master.csv
build_src_filter = 
    +<*> 
    -<main_hello.cpp>
    -<main_diag_boot.cpp>
    -<main_pressione.cpp> 
    -<main_relay.cpp> 
    -<main_motore.cpp> 
    -<main_easyconnect.cpp>
    -<RS485_Slave.cpp> 
    -<Serial_Slave.cpp>
    -<main_test.cpp>
lib_deps = 
    SPI
    Wire
    adafruit/Adafruit SHTC3 Library @ ^1.0.1
    bluerobotics/BlueRobotics MS5837 Library @ ^1.1.1

; --- 2. SCHEDA PRESSIONE (Slave esistente) ---
[env:pressione]
; Applica lo schema partizioni corretto per OTA slave
board_build.partitions = partitions.csv
build_src_filter = 
    +<*> 
    -<main_hello.cpp>
    -<main_diag_boot.cpp>
    -<main_master.cpp> 
    -<main_relay.cpp> 
    -<main_motore.cpp> 
    -<main_easyconnect.cpp>
    -<WebHandler.cpp> 
    -<RS485_Master.cpp> 
    -<Serial_Master.cpp> 
    -<Calibration.cpp> 
    -<MembraneKeyboard.cpp>
lib_deps = 
    SPI
    Wire
    adafruit/Adafruit SHTC3 Library @ ^1.0.1
    bluerobotics/BlueRobotics MS5837 Library @ ^1.1.1

; --- 3. SCHEDA RELAY (Da sviluppare) ---
[env:relay]
build_src_filter = 
    +<*>
    -<main_hello.cpp>
    -<main_diag_boot.cpp>
    -<main_master.cpp>
    -<main_pressione.cpp>
    -<main_motore.cpp>
    -<main_easyconnect.cpp>
    -<WebHandler.cpp>
    -<RS485_Master.cpp>
    -<Serial_Master.cpp>
    -<Calibration.cpp>
    -<MembraneKeyboard.cpp>
    ; Nota: RS485_Slave.cpp è specifico per la pressione, ne faremo uno per i relay
    -<RS485_Slave.cpp> 
lib_deps = 
    SPI
    Wire

; --- 4. SCHEDA MOTORE (Da sviluppare su HW Pressione) ---
[env:motore]
build_src_filter = 
    +<*>
    -<main_hello.cpp>
    -<main_diag_boot.cpp>
    -<main_master.cpp>
    -<main_pressione.cpp>
    -<main_relay.cpp>
    -<main_easyconnect.cpp>
    -<WebHandler.cpp>
    -<RS485_Master.cpp>
    -<Serial_Master.cpp>
    -<Calibration.cpp>
    -<MembraneKeyboard.cpp>
    -<RS485_Slave.cpp>
lib_deps = 
    SPI
    Wire

; --- 5. SCHEDA EASYCONNECT (Master con Display - Da sviluppare) ---
[env:easyconnect]
build_src_filter = 
    +<*>
    -<main_hello.cpp>
    -<main_diag_boot.cpp>
    -<main_master.cpp>
    -<main_pressione.cpp>
    -<main_relay.cpp>
    -<main_motore.cpp>
    -<RS485_Slave.cpp>
    -<Serial_Slave.cpp>
    ; Qui serviranno librerie per il display
lib_deps = 
    SPI
    Wire

; --- RECOVERY: MASTER con seriale UART classica (USB CDC disabilitata) ---
[env:master_rewamping_recovery_uart]
extends = env:master_rewamping
build_unflags =
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
build_flags =
    ${env.build_flags}
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=0

; --- RECOVERY: MASTER con FLASH MODE QIO (solo per test diagnosi boot) ---
[env:master_rewamping_recovery_qio]
extends = env:master_rewamping
board_build.flash_mode = qio

; --- DIAGNOSTICA: firmware minimale seriale ---
[env:diagnostic_hello]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
board_build.flash_mode = dio
build_flags =
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
build_src_filter =
    +<main_hello.cpp>

; --- DIAGNOSTICA HARD: UART classica + heartbeat GPIO ---
[env:diagnostic_hard]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
upload_speed = 115200
board_build.flash_mode = dio
build_flags =
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=0
build_src_filter =
    +<main_diag_boot.cpp>
